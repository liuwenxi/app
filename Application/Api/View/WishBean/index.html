<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>我的心愿豆</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="APP_DEFAULT_PATH/css/mui.min.css" />
    <link rel="stylesheet" type="text/css" href="APP_DEFAULT_PATH/css/wishBean.css" />
</head>

<body>
    <include file="Public/inc/header" />
    <div class="mui-content wish-bean">
        <div class="wish-bean-chart">
            <div class="head">
                <span class="total-count">近期支出：<big>{$conmon}</big></span>
                <span class="mui-pull-right" id="bill">账单<i class="mui-icon mui-icon-arrowright"></i></span>
            </div>
            <div id="wishBean" style="width: 100%;height:130px;"></div>
        </div>
        <div class="wish-bean-operation">
            <div class="underline-tab mui-segmented-control">
                <a class="mui-control-item mui-active" href="#exchange">兑换心愿豆</a>
                <a class="mui-control-item" href="#redemption">赎回心愿豆</a>
            </div>
            <div class="index-segmented-content">
                <div id="exchange" class="mui-control-content mui-active">
                    <div class="wish-bean-count">
                        你当前心愿豆余额：<span class="count">{$mon}</span>
                        <span class="description mui-pull-right" id="exchangeInfo">兑换说明</span>
                    </div>
                    <div class="select-bean-count-warpper">
                        <div class="select-bean-count">
                            <h5>请选择想要兑换的心愿豆的数量</h5>
                            <ul class="select-type clearfix">
                                <li>
                                    <span class="count">10</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：1元</span>
                                </li>
                                <li>
                                    <span class="count">20</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：2元</span>
                                </li>
                                <li>
                                    <span class="count">30</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：3元</span>
                                </li>
                                <li>
                                    <span class="count">50</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：5元</span>
                                </li>
                                <li>
                                    <span class="count">100</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：10元</span>
                                </li>
                                <li>
                                    <span class="count">200</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：20元</span>
                                </li>
                                <li>
                                    <span class="count">300</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：30元</span>
                                </li>
                                <li>
                                    <span class="count">500</span>
                                    <span>心愿豆</span>
                                    <span class="price">售价：50元</span>
                                </li>
                                <li id="randomBean">
                                    <span class="random">随机</span>
                                </li>
                            </ul>
                            <div class="selected-count"><span id="count" class="count">1.00</span>元</div>
                            <p>兑换心愿豆：<span id="bean" class="bean">10</span>心愿豆</p>
                        </div>
                        <a class="btn-lg" id="pay">立即支付</a>
                    </div>
                </div>
                <div id="redemption" class="mui-control-content ">
                    <div class="wish-bean-count">
                        心愿豆余额：<span class="count">{$mon}</span>心愿豆
                        <span class="description mui-pull-right" id="redemptionInfo">赎回说明</span>
                    </div>
                    <div class="cashing-warpper">
                        <p>赎回心愿豆最低数量1050起（￥100元）</p>
                        <div class="cashing">
                            <label>可提现金额：<span class="cash">{$tmon}</span></label>
                            <input type="text" placeholder="请输入提现金额" onafterpaste="this.value=this.value.replace(/\D/g,'')" id='money'>
                            <p id="vertifyTips"></p>
                            <a class="btn-lg" id="redeem">下一步</a>
                            <p>提示：每天最多可提现金伍仟元整</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="payActionsheet" class="mui-popover mui-popover-bottom mui-popover-action ">
        <ul class="mui-table-view">
            <!--<li class="mui-table-view-cell disable">-->
            <li class="mui-table-view-cell">
                <a href="#" id='doPay'><i class="mui-icon mui-icon-weixin"></i>微信支付</a>
                <p>浏览器不支持微信支付，需要通过微心愿公众号登录进行操作</p>
            </li>
            <!--<li class="mui-table-view-cell">-->
            <!--<a href="#" id='doAliPay' ><i class="mui-icon mui-icon-weibo"></i>支付宝支付</a>-->
            <!--<p>微信不支持微信支付，如有需要请用浏览器打开进行操作</p>-->
            <!--</li>-->
        </ul>
        <ul class="mui-table-view">
            <li class="mui-table-view-cell">
                <a id="cancel"><b>取消</b></a>
            </li>
        </ul>
    </div>
    <div class="mui-backdrop exchangeInfo hide">
        <div class="info-dialog">
            <div class="dialog-inner">
                <div class="dialog-title clearfix">
                    <i class="mui-icon mui-icon-closeempty mui-pull-right"></i>
                </div>
                <div class="dialog-content">
                    <h4>兑换说明</h4>
                    <h6>如何兑换心愿豆？</h6>
                    <p>通过现金兑换心愿豆。用户可以点击“个人-心愿豆-兑换心愿豆”栏目，兑换比例为人民币1元兑换10心愿豆</p>
                </div>
            </div>
        </div>
    </div>
    <div class="mui-backdrop redemptionInfo hide">
        <div class="info-dialog">
            <div class="dialog-inner">
                <div class="dialog-title clearfix">
                    <i class="mui-icon mui-icon-closeempty mui-pull-right"></i>
                </div>
                <div class="dialog-content">
                    <h4>赎回说明</h4>
                    <h6>如何“赎回”心愿豆？</h6>
                    <p>目前，微心愿只提供心愿豆1050个以上的用户赎回心愿豆。当用户账户心愿豆达到1050以上，即可通过微心愿进行赎回。心愿豆赎回时，用户同意微心愿按照最低1050心愿豆兑换人民币100元的比例提供赎回服务。</p>
                </div>
            </div>
        </div>
    </div>
    <script src="APP_DEFAULT_PATH/js/mui.js" type="text/javascript" charset="utf-8"></script>
    <script src="APP_DEFAULT_PATH/js/echarts.common.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="__APP__js/pingpp.js" type="text/javascript"></script>
    <script>
    </script>
    <script type="text/javascript">
    mui.ready(function() {
        mui('.mui-bar').on('tap', '.logo', function() {
            mui.openWindow({
                url: "{:U('Index/index')}",
                id: 'recommend'
            });
        });
        mui.init();
        /*操作表*/
        document.querySelector('#pay').addEventListener('tap', function() {
            mui('#payActionsheet').popover('toggle');
        });
        document.querySelector('#cancel').addEventListener('tap', function() {
            mui('#payActionsheet').popover('toggle');
        });
        /*兑换心愿豆数目生成*/
        mui('.select-type').on('tap', '.select-type li', function() {
            mui('.select-type li').each(function(i, e) {
                e.classList.remove('active');
            });
            this.classList.add('active');
            if (this.id == 'randomBean') {
                var number = parseInt(Math.random() * 50) + 1;
                mui('#count')[0].innerHTML = number + '.00';
                mui('#bean')[0].innerHTML = number * 10;
            } else {
                mui('#count')[0].innerHTML = this.children[0].innerHTML / 10 + '.00';
                mui('#bean')[0].innerHTML = this.children[0].innerHTML;
            }

        });
        /*提交跳转到支付宝控制器*/
        //     document.getElementById('doAliPay').addEventListener('tap', function() {
        //
        //         var count = mui('#count')[0].innerHTML;
        //          alert(count);
        //                mui.openWindow({
        //                url: '/App/Payment/doAliPay/m/'+count,
        //                id: 'doAliPay'
        //         });
        //      });

        /*提交跳转到支付宝控制器*/
        document.getElementById('doPay').addEventListener('tap', function() {

            var count = mui('#count')[0].innerHTML;
            wap_pay('wx_pub', count);
        });

        function wap_pay(channel, count) {
            //var amount = document.getElementById('amount').value * 100;
            var amount = count;
            var xhr = new XMLHttpRequest();
            var strCookie = document.cookie;
            //将多cookie切割为多个名/值对
            var arrCookie = strCookie.split("; ");
            var jump_url;
            //遍历cookie数组，处理每个cookie对
            for (var i = 0; i < arrCookie.length; i++) {
                var arr = arrCookie[i].split("=");
                //找到名称为userId的cookie，并返回它的值
                if ("jump_url" == arr[0]) {
                    jump_url = arr[1];
                    break;
                }
            }
            if (jump_url == undefined) {
                jump_url = "{:U('Index/index')}";
            }
            xhr.open("POST", "{:U('Payment/doPay')}", true);
            xhr.setRequestHeader("Content-type", "application/json");
            xhr.send(JSON.stringify({
                channel: channel,
                amount: amount
            }));
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    //                console.log(xhr.responseText.order_no);
                    var obj = eval("(" + xhr.responseText + ")");
                    pingpp.createPayment(xhr.responseText, function(result, err) {
                        console.log(result);
                        console.log(err.msg);
                        console.log(err.extra);
                        if (result == "cancel") {
                            mui.ajax("{:U('Payment/cancelOrder')}", {
                                type: "POST",
                                dataType: "JSON",
                                data: {
                                    ord_no: obj["order_no"]
                                },
                                success: function() {

                                }
                            });
                            mui.alert("你已取消支付!", ' ', ['好的'], null);
                            document.querySelector('.mui-popup-title').style.backgroundImage = "url('APP_DEFAULT_PATH/image/blink.png')";
                            setTimeout(function() {
                                window.location.href = jump_url;
                            }, 3000);
                        } else if (result == "fail") {
                            mui.alert("支付失败！原因可能是你没在微信端登录微信!", ' ', ['好的'], null);
                            document.querySelector('.mui-popup-title').style.backgroundImage = "url('APP_DEFAULT_PATH/image/tears.png')";
//                            setTimeout(function() {
//                                window.location.href = jump_url;
//                            }, 3000);
                        } else if (result == "success") {
                            mui.alert("支付成功!", ' ', ['好的'], null);
                            document.querySelector('.mui-popup-title').style.backgroundImage = "url('APP_DEFAULT_PATH/image/smile.png')";
                            setTimeout(function() {
                                window.location.href = jump_url;
                            }, 3000);
                        }
                    });
                }
            }
        }

        /*控制跳转*/
        document.getElementById('bill').addEventListener('tap', function() {
            mui.openWindow({
                url: "{:U('WishBean/bill')}",
                id: 'bill'
            });
        });
       /*图表化*/
        var listdata = {$listdata};
        var listmon = {$listmon};
        //        var obj  = JSON.parse({$list})
        var myChart = echarts.init(document.getElementById('wishBean'));

        option = {
            grid: {
                left: '0%',
                right: '5%',
                bottom: '20%',
                top: '5%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: listdata.split(','),
                axisLine: {
                    show: false,
                    lineStyle: {
                        color: '#8ddbfd'
                    }
                },
                splitLine: {
                    show: true,
                    lineStyle: {
                        color: '#8ddbfd'
                    }
                }

            },
            yAxis: {
                type: 'value',
                minInterval: 1,
                min: '0',
                axisLine: {
                    show: false,
                    lineStyle: {
                        color: '#8ddbfd'
                    }
                },
                splitLine: {
                    show: false
                }
            },

            backgroundColor: 'rgb(96, 206, 255)',
            series: [{
                name: '支出',
                type: 'line',
                data: listmon.split(','),
            }],
            color: ['#fabe32', '#f00']
        };
        myChart.setOption(option);
        /*说明弹出框*/
        mui('.dialog-title').on('tap', 'i', function() {
            this.parentNode.parentNode.parentNode.parentNode.classList.toggle('hide');
        });
        document.getElementById('exchangeInfo').addEventListener('tap', function() {
            mui('.exchangeInfo')[0].classList.toggle('hide');
        });
        document.getElementById('redemptionInfo').addEventListener('tap', function() {
            mui('.redemptionInfo')[0].classList.toggle('hide');
        });
        /*控制跳转*/
        document.getElementById('bill').addEventListener('tap', function() {
            mui.openWindow({
                url: "{:U('WishBean/bill')}",
                id: 'bill'
            });
        });
        /*金额表单验证*/
        var tips = document.getElementById('vertifyTips')
        document.getElementById('money').addEventListener('keyup', function() {
            var val = parseInt(this.value);

            if (Number.isNaN(val)) {
                tips.innerHTML = "请输入数字";
                this.value = "";
            } else {
                tips.innerHTML = ""
            }
        });
        document.getElementById('redeem').addEventListener('tap', function() {
            var mon = document.getElementById('money').value;
            if (mon == '') {
                mui.alert('请输入金额', '', ['好的'], null);
                return false;
            } else if (mon % 100 != 0) {
                mui.alert('赎回金额应为100的整数倍如300或1200', '', ['好的'], null);
                return false;
            } else if (mon > 5000) {
                mui.alert('赎回金额不能超过5000元', '', ['好的'], null);
                return false;
            }
            mui.ajax("{:U('WishBean/ajax_money')}", {
                type: 'POST',
                dataType: 'JSON',
                data: {
                    mon: mon
                },
                success: function(json) {
                    console.log(json);
                    var json_obj = JSON.parse(json);
                    if (json == 4) {
                        mui.confirm('您还没有实名认证！请先完善资料！', ' ', ['我再看看', '马上完善'], function(v) {
                            if (v.index == 1) {
                                mui.openWindow({
                                    url: "{:U('UserCenter/nameVerify')}",
                                    id: 'nameVerify'
                                });
                            }
                        });
                        document.querySelector('.mui-popup-title').style.backgroundImage = "url('APP_DEFAULT_PATH/image/blink.png')";
                        return false;
                    } else if (json == 6) {
                        mui.confirm('你的实名认证审核没有通过，请修改认证成功后再赎回', ' ', ['下次', '火速前往'], function(v) {
                            if (v.index == 1) {
                                mui.openWindow({
                                    url: "{:U('UserCenter/nameVerify')}",
                                    id: 'nameVerify'
                                });
                            }
                        });
                        document.querySelector('.mui-popup-title').style.backgroundImage = "url('APP_DEFAULT_PATH/image/blink.png')";
                        return false;
                    } else if (json == 0) {
                        console.log(json);
                        mui.openWindow({
                            url: "{:U('WishBean/redeem')}",
                            id: 'redeem'
                        });
                    } else {
                        mui.alert(json_obj.msg, ' ', ['好的'], null);
                        document.querySelector('.mui-popup-title').style.backgroundImage = "url('APP_DEFAULT_PATH/image/blink.png')";
                        return false;
                    }
                },
            });
        });
    });
    </script>
</body>

</html>
